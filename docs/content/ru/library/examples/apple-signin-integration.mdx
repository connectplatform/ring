---
title: Интеграция входа через Apple
description: Полное руководство по реализации Sign in with Apple в платформе Ring
---

# Руководство по интеграции входа через Apple

Это руководство предоставляет полный разбор интеграции **Sign in with Apple** в ваше приложение Ring Platform.

## Список необходимых условий

- ✅ Аккаунт разработчика Apple ($99/год)
- ✅ App ID зарегистрированный с возможностью Sign in with Apple
- ✅ Service ID настроенный для веб-аутентификации
- ✅ Приватный ключ (.p8 файл) загружен и защищен
- ✅ Team ID из аккаунта разработчика Apple

## Быстрая настройка (5 минут)

Если у вас уже есть учетные данные Apple, вот самый быстрый способ запустить вход через Apple:

### 1. Переменные окружения

Добавьте в ваш `.env.local`:

<Code language="bash" title="AUTH_APPLE_ID=com.sonoratek.ring-auth">
{`AUTH_APPLE_SECRET=<ваш-jwt-токен-здесь>`}
</Code>

### 2. Генерация JWT токена

Запустите наш вспомогательный скрипт:

<Code language="bash" title="terminal">
{`cd scripts
node generate-apple-jwt.js`}
</Code>

Или сгенерируйте вручную с помощью Node.js:

<Code language="javascript" title="import jwt from 'jsonwebtoken';">
{`import fs from 'fs';

const token = jwt.sign(
  {
    iss: 'X9EQDPCJU6', // Ваш Team ID
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 15777000,
    aud: 'https://appleid.apple.com',
    sub: 'com.sonoratek.ring-auth',
  },
  fs.readFileSync('AuthKey_YD444LWM9J.p8'),
  { algorithm: 'ES256', keyid: 'YD444LWM9J' }
);`}
</Code>

### 3. Добавьте в ваш компонент входа

<Code language="typescript" title="'use client'">
{`import { signIn } from 'next-auth/react'
import { AppleIcon } from '@/components/icons'

export function LoginForm() {
  return (
    <div className="space-y-4">
      <button
        onClick={() => signIn('apple')}
        className="w-full flex items-center justify-center gap-2 bg-black text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors"
      >
        <AppleIcon className="w-5 h-5" />
        Продолжить с Apple
      </button>
    </div>
  )
}`}
</Code>

Вот и все! Вход через Apple теперь активен в вашем приложении.

## Полный пример реализации

Вот полный пример интеграции входа через Apple в компонент входа:

// components/auth/AppleSignInButton.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { signIn, getSession } from 'next-auth/react'
import { useState } from 'react'
import { AppleIcon } from '@/components/icons'

interface AppleSignInButtonProps {
  className?: string
  size?: 'sm' | 'md' | 'lg'
  variant?: 'primary' | 'secondary'
}

export function AppleSignInButton({
  className = '',
  size = 'md',
  variant = 'primary'
}: AppleSignInButtonProps) {
  const [isLoading, setIsLoading] = useState(false)

  const handleAppleSignIn = async () => {
    try {
      setIsLoading(true)

      const result = await signIn('apple', {
        callbackUrl: '/dashboard',
        redirect: false
      })

      if (result?.error) {
        console.error('Ошибка входа через Apple:', result.error)
        // Обработка ошибки (показать уведомление и т.д.)
      } else if (result?.url) {
        window.location.href = result.url
      }
    } catch (error) {
      console.error('Вход через Apple не удался:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const sizeClasses = {
    sm: 'py-2 px-3 text-sm',
    md: 'py-3 px-4 text-base',
    lg: 'py-4 px-6 text-lg'
  }

  const variantClasses = {
    primary: 'bg-black text-white hover:bg-gray-800 border-black',
    secondary: 'bg-white text-black border-gray-300 hover:bg-gray-50'
  }

  return (
    <button
      onClick={handleAppleSignIn}
      disabled={isLoading}
      className={`
        w-full flex items-center justify-center gap-3 border rounded-lg
        transition-all duration-200 font-medium
        disabled:opacity-50 disabled:cursor-not-allowed
        ${sizeClasses[size]}
        ${variantClasses[variant]}
        ${className}
      `}
    >
      {isLoading ? (
        <div className="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin" />
      ) : (
        <AppleIcon className="w-5 h-5" />
      )}
      {isLoading ? 'Выполняется вход...' : 'Продолжить с Apple'}
    </button>
  )
}`}
</Code>

## Интеграция с существующим потоком входа

Вот как интегрировать вход через Apple с вашим существующим UI аутентификации:

// components/auth/SocialLoginSection.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { signIn } from 'next-auth/react'
import { AppleIcon, GoogleIcon } from '@/components/icons'

export function SocialLoginSection() {
  const handleProviderSignIn = async (provider: 'google' | 'apple') => {
    try {
      await signIn(provider, {
        callbackUrl: '/onboarding',
        redirect: true
      })
    } catch (error) {
      console.error(`Ошибка входа через ${provider}:`, error)
    }
  }

  return (
    <div className="space-y-4">
      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <div className="w-full border-t border-gray-300" />
        </div>
        <div className="relative flex justify-center text-sm">
          <span className="px-2 bg-white text-gray-500">Или продолжить с</span>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-3">
        <button
          onClick={() => handleProviderSignIn('google')}
          className="flex items-center justify-center gap-2 py-2.5 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        >
          <GoogleIcon className="w-5 h-5" />
          <span className="text-sm font-medium">Google</span>
        </button>

        <button
          onClick={() => handleProviderSignIn('apple')}
          className="flex items-center justify-center gap-2 py-2.5 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        >
          <AppleIcon className="w-5 h-5" />
          <span className="text-sm font-medium">Apple</span>
        </button>
      </div>
    </div>
  )
}`}
</Code>

## Обработка обратных вызовов входа через Apple

// app/auth/callback/apple/page.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { useEffect, useState } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'

export default function AppleCallback() {
  const { data: session, status } = useSession()
  const router = useRouter()
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (status === 'loading') return

    if (session?.user) {
      // Успешный вход
      router.push('/dashboard')
    } else {
      // Проверка ошибки в параметрах URL
      const urlParams = new URLSearchParams(window.location.search)
      const errorParam = urlParams.get('error')

      if (errorParam) {
        setError(`Аутентификация не удалась: ${errorParam}`)
      }
    }
  }, [session, status, router])

  if (status === 'loading') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-black mx-auto"></div>
          <p className="mt-4 text-gray-600">Завершение входа...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-600 mb-4">⚠️ {error}</div>
          <button
            onClick={() => router.push('/login')}
            className="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800"
          >
            Попробовать снова
          </button>
        </div>
      </div>
    )
  }

  return null
}`}
</Code>

## Кастомизация опыта входа через Apple

### Опции стилизации

// Кастомная стилизованная кнопка Apple

<Code language="typescript" title="TypeScript">
{`export function CustomAppleButton() {
  return (
    <button
      onClick={() => signIn('apple')}
      className="group relative w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg hover:border-gray-400 transition-colors"
    >
      <div className="absolute left-4">
        <svg className="w-5 h-5" viewBox="0 0 24 24">
          <path
            fill="currentColor"
            d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"
          />
        </svg>
      </div>
      <span className="text-gray-700 font-medium">Войти с Apple</span>
    </button>
  )
}`}
</Code>

## Тестирование входа через Apple

### Тестирование в разработке

1. **Используйте TestFlight**: Apple предоставляет TestFlight для тестирования Sign in with Apple
2. **Песочница**: Apple предоставляет тестовые аккаунты для тестирования
3. **Сертификаты разработки**: Используйте сертификаты разработки для тестирования

### Тестирование в продакшене

1. **Проверка App Store**: Apple проверяет реализацию Sign in with Apple
2. **Политика приватности**: Убедитесь, что ваша политика приватности упоминает Sign in with Apple
3. **Согласие пользователя**: Проверьте, что пользователи понимают, какие данные Apple передает

## Устранение распространенных проблем

### Ошибка "Invalid Client"

// Проверьте ваши переменные окружения

<Code language="typescript" title="TypeScript">
{`console.log('APPLE_ID:', process.env.AUTH_APPLE_ID)
console.log('APPLE_SECRET длина:', process.env.AUTH_APPLE_SECRET?.length)

// Проверьте соответствие Service ID
const expectedServiceId = 'com.sonoratek.ring-auth'
const actualServiceId = process.env.AUTH_APPLE_ID

if (actualServiceId !== expectedServiceId) {
  console.error('Несоответствие Service ID!')
}`}
</Code>

### Проблемы с JWT токеном

// Валидация структуры JWT

<Code language="typescript" title="TypeScript">
{`import jwt from 'jsonwebtoken'

function validateAppleJWT(token: string) {
  try {
    const decoded = jwt.decode(token, { complete: true })
    console.log('JWT Header:', decoded?.header)
    console.log('JWT Payload:', decoded?.payload)

    // Проверка истечения срока
    const exp = decoded?.payload?.exp
    if (exp && exp < Date.now() / 1000) {
      console.error('JWT токен истек!')
    }
  } catch (error) {
    console.error('Неверный JWT:', error)
  }
}`}
</Code>

### Верификация домена

Убедитесь, что ваш домен правильно настроен в Apple Developer Portal:

1. Перейдите в конфигурацию вашего Service ID
2. Добавьте ваш домен в "Domains and Subdomains"
3. Добавьте return URLs для вашего приложения
4. Проверьте владение доменом с файлом верификации Apple

## Оптимизация производительности

### Стратегии кеширования

<Code language="typescript" title="TypeScript">
{`// Кеширование JWT токенов (регенерация каждые 5 месяцев вместо 6)
const JWT_CACHE_DURATION = 5 * 30 * 24 * 60 * 60 * 1000 // 5 месяцев

export function getCachedAppleJWT() {
  const cached = localStorage.getItem('apple-jwt')
  const cacheTime = localStorage.getItem('apple-jwt-time')

  if (cached && cacheTime) {
    const age = Date.now() - parseInt(cacheTime)
    if (age < JWT_CACHE_DURATION) {
      return cached
    }
  }

  // Генерация нового токена
  const newToken = generateAppleJWT()
  localStorage.setItem('apple-jwt', newToken)
  localStorage.setItem('apple-jwt-time', Date.now().toString())

  return newToken
}`}
</Code>

## Лучшие практики безопасности

1. **Ротация ключей**: Регулярно обновляйте приватные ключи
2. **Изоляция окружений**: Используйте разные ключи для dev/staging/production
3. **Аудит логирования**: Логируйте все попытки аутентификации
4. **Ограничение частоты**: Реализуйте ограничение частоты запросов на конечные точки входа
5. **Валидация токенов**: Всегда валидируйте токены на стороне сервера

## Миграция с других провайдеров

При миграции с аутентификации только через Google:

<Code language="typescript" title="TypeScript">
{`// До (только Google)
<button onClick={() => signIn('google')}>
  Войти через Google
</button>

// После (множественные провайдеры)
<div className="space-y-2">
  <button onClick={() => signIn('google')}>
    Войти через Google
  </button>
  <button onClick={() => signIn('apple')}>
    Войти через Apple
  </button>
</div>`}
</Code>

Эта реализация предоставляет бесшовный, безопасный и удобный для пользователя опыт входа через Apple для пользователей вашей платформы Ring.
