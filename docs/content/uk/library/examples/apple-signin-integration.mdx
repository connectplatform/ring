---
title: Інтеграція входу через Apple
description: Повний посібник з реалізації Sign in with Apple у платформі Ring
---

# Посібник з інтеграції входу через Apple

Цей посібник надає повний розбір інтеграції **Sign in with Apple** у вашу програму Ring Platform.

## Список необхідних умов

- ✅ Обліковий запис розробника Apple ($99/рік)
- ✅ App ID зареєстрований із можливістю Sign in with Apple
- ✅ Service ID налаштований для веб-аутентифікації
- ✅ Приватний ключ (.p8 файл) завантажений і захищений
- ✅ Team ID з облікового запису розробника Apple

## Швидке налаштування (5 хвилин)

Якщо у вас уже є облікові дані Apple, ось найшвидший спосіб запустити вхід через Apple:

### 1. Змінні середовища

Додайте до вашого `.env.local`:

<Code language="bash" title="AUTH_APPLE_ID=com.sonoratek.ring-auth">
{`AUTH_APPLE_SECRET=<ваш-jwt-токен-тут>`}
</Code>

### 2. Генерація JWT токена

Запустіть наш допоміжний скрипт:

<Code language="bash" title="terminal">
{`cd scripts
node generate-apple-jwt.js`}
</Code>

Або згенеруйте вручну за допомогою Node.js:

<Code language="javascript" title="import jwt from 'jsonwebtoken';">
{`import fs from 'fs';

const token = jwt.sign(
  {
    iss: 'X9EQDPCJU6', // Ваш Team ID
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 15777000,
    aud: 'https://appleid.apple.com',
    sub: 'com.sonoratek.ring-auth',
  },
  fs.readFileSync('AuthKey_YD444LWM9J.p8'),
  { algorithm: 'ES256', keyid: 'YD444LWM9J' }
);`}
</Code>

### 3. Додайте до вашого компонента входу

<Code language="typescript" title="'use client'">
{`import { signIn } from 'next-auth/react'
import { AppleIcon } from '@/components/icons'

export function LoginForm() {
  return (
    <div className="space-y-4">
      <button
        onClick={() => signIn('apple')}
        className="w-full flex items-center justify-center gap-2 bg-black text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors"
      >
        <AppleIcon className="w-5 h-5" />
        Продовжити з Apple
      </button>
    </div>
  )
}`}
</Code>

Ось і все! Вхід через Apple тепер активний у вашій програмі.

## Повний приклад реалізації

Ось повний приклад інтеграції входу через Apple у компонент входу:

// components/auth/AppleSignInButton.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { signIn, getSession } from 'next-auth/react'
import { useState } from 'react'
import { AppleIcon } from '@/components/icons'

interface AppleSignInButtonProps {
  className?: string
  size?: 'sm' | 'md' | 'lg'
  variant?: 'primary' | 'secondary'
}

export function AppleSignInButton({
  className = '',
  size = 'md',
  variant = 'primary'
}: AppleSignInButtonProps) {
  const [isLoading, setIsLoading] = useState(false)

  const handleAppleSignIn = async () => {
    try {
      setIsLoading(true)

      const result = await signIn('apple', {
        callbackUrl: '/dashboard',
        redirect: false
      })

      if (result?.error) {
        console.error('Помилка входу через Apple:', result.error)
        // Обробка помилки (показати сповіщення тощо)
      } else if (result?.url) {
        window.location.href = result.url
      }
    } catch (error) {
      console.error('Вхід через Apple не вдався:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const sizeClasses = {
    sm: 'py-2 px-3 text-sm',
    md: 'py-3 px-4 text-base',
    lg: 'py-4 px-6 text-lg'
  }

  const variantClasses = {
    primary: 'bg-black text-white hover:bg-gray-800 border-black',
    secondary: 'bg-white text-black border-gray-300 hover:bg-gray-50'
  }

  return (
    <button
      onClick={handleAppleSignIn}
      disabled={isLoading}
      className={`
        w-full flex items-center justify-center gap-3 border rounded-lg
        transition-all duration-200 font-medium
        disabled:opacity-50 disabled:cursor-not-allowed
        ${sizeClasses[size]}
        ${variantClasses[variant]}
        ${className}
      `}
    >
      {isLoading ? (
        <div className="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin" />
      ) : (
        <AppleIcon className="w-5 h-5" />
      )}
      {isLoading ? 'Виконується вхід...' : 'Продовжити з Apple'}
    </button>
  )
}`}
</Code>

## Інтеграція з існуючим потоком входу

Ось як інтегрувати вхід через Apple з вашим існуючим UI аутентифікації:

// components/auth/SocialLoginSection.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { signIn } from 'next-auth/react'
import { AppleIcon, GoogleIcon } from '@/components/icons'

export function SocialLoginSection() {
  const handleProviderSignIn = async (provider: 'google' | 'apple') => {
    try {
      await signIn(provider, {
        callbackUrl: '/onboarding',
        redirect: true
      })
    } catch (error) {
      console.error(`Помилка входу через ${provider}:`, error)
    }
  }

  return (
    <div className="space-y-4">
      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <div className="w-full border-t border-gray-300" />
        </div>
        <div className="relative flex justify-center text-sm">
          <span className="px-2 bg-white text-gray-500">Або продовжити з</span>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-3">
        <button
          onClick={() => handleProviderSignIn('google')}
          className="flex items-center justify-center gap-2 py-2.5 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        >
          <GoogleIcon className="w-5 h-5" />
          <span className="text-sm font-medium">Google</span>
        </button>

        <button
          onClick={() => handleProviderSignIn('apple')}
          className="flex items-center justify-center gap-2 py-2.5 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        >
          <AppleIcon className="w-5 h-5" />
          <span className="text-sm font-medium">Apple</span>
        </button>
      </div>
    </div>
  )
}`}
</Code>

## Обробка зворотних викликів входу через Apple

// app/auth/callback/apple/page.tsx

<Code language="typescript" title="TypeScript">
{`'use client'

import { useEffect, useState } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'

export default function AppleCallback() {
  const { data: session, status } = useSession()
  const router = useRouter()
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (status === 'loading') return

    if (session?.user) {
      // Успішний вхід
      router.push('/dashboard')
    } else {
      // Перевірка помилки в параметрах URL
      const urlParams = new URLSearchParams(window.location.search)
      const errorParam = urlParams.get('error')

      if (errorParam) {
        setError(`Аутентифікація не вдалася: ${errorParam}`)
      }
    }
  }, [session, status, router])

  if (status === 'loading') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-black mx-auto"></div>
          <p className="mt-4 text-gray-600">Завершення входу...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-600 mb-4">⚠️ {error}</div>
          <button
            onClick={() => router.push('/login')}
            className="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800"
          >
            Спробувати знову
          </button>
        </div>
      </div>
    )
  }

  return null
}`}
</Code>

## Кастомізація досвіду входу через Apple

### Опції стилізації

// Кастомна стилізована кнопка Apple

<Code language="typescript" title="TypeScript">
{`export function CustomAppleButton() {
  return (
    <button
      onClick={() => signIn('apple')}
      className="group relative w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg hover:border-gray-400 transition-colors"
    >
      <div className="absolute left-4">
        <svg className="w-5 h-5" viewBox="0 0 24 24">
          <path
            fill="currentColor"
            d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"
          />
        </svg>
      </div>
      <span className="text-gray-700 font-medium">Увійти з Apple</span>
    </button>
  )
}`}
</Code>

## Тестування входу через Apple

### Тестування у розробці

1. **Використовуйте TestFlight**: Apple надає TestFlight для тестування Sign in with Apple
2. **Пісочниця**: Apple надає тестові облікові записи для тестування
3. **Сертифікати розробки**: Використовуйте сертифікати розробки для тестування

### Тестування у продакшені

1. **Перевірка App Store**: Apple перевіряє реалізацію Sign in with Apple
2. **Політика приватності**: Переконайтеся, що ваша політика приватності згадує Sign in with Apple
3. **Згода користувача**: Перевірте, що користувачі розуміють, які дані Apple передає

## Усунення поширених проблем

### Помилка "Invalid Client"

// Перевірте ваші змінні середовища

<Code language="typescript" title="TypeScript">
{`console.log('APPLE_ID:', process.env.AUTH_APPLE_ID)
console.log('APPLE_SECRET довжина:', process.env.AUTH_APPLE_SECRET?.length)

// Перевірте відповідність Service ID
const expectedServiceId = 'com.sonoratek.ring-auth'
const actualServiceId = process.env.AUTH_APPLE_ID

if (actualServiceId !== expectedServiceId) {
  console.error('Невідповідність Service ID!')
}`}
</Code>

### Проблеми з JWT токеном

// Валідація структури JWT

<Code language="typescript" title="TypeScript">
{`import jwt from 'jsonwebtoken'

function validateAppleJWT(token: string) {
  try {
    const decoded = jwt.decode(token, { complete: true })
    console.log('JWT Header:', decoded?.header)
    console.log('JWT Payload:', decoded?.payload)

    // Перевірка закінчення терміну
    const exp = decoded?.payload?.exp
    if (exp && exp < Date.now() / 1000) {
      console.error('JWT токен закінчився!')
    }
  } catch (error) {
    console.error('Неправильний JWT:', error)
  }
}`}
</Code>

### Верифікація домену

Переконайтеся, що ваш домен правильно налаштований у Apple Developer Portal:

1. Перейдіть до конфігурації вашого Service ID
2. Додайте ваш домен до "Domains and Subdomains"
3. Додайте return URLs для вашої програми
4. Перевірте володіння доменом із файлом верифікації Apple

## Оптимізація продуктивності

### Стратегії кешування

<Code language="typescript" title="TypeScript">
{`// Кешування JWT токенів (регенерація кожні 5 місяців замість 6)
const JWT_CACHE_DURATION = 5 * 30 * 24 * 60 * 60 * 1000 // 5 місяців

export function getCachedAppleJWT() {
  const cached = localStorage.getItem('apple-jwt')
  const cacheTime = localStorage.getItem('apple-jwt-time')

  if (cached && cacheTime) {
    const age = Date.now() - parseInt(cacheTime)
    if (age < JWT_CACHE_DURATION) {
      return cached
    }
  }

  // Генерація нового токена
  const newToken = generateAppleJWT()
  localStorage.setItem('apple-jwt', newToken)
  localStorage.setItem('apple-jwt-time', Date.now().toString())

  return newToken
}`}
</Code>

## Найкращі практики безпеки

1. **Ротація ключів**: Регулярно оновлюйте приватні ключі
2. **Ізоляція середовищ**: Використовуйте різні ключі для dev/staging/production
3. **Аудит логування**: Логуйте всі спроби аутентифікації
4. **Обмеження частоти**: Реалізуйте обмеження частоти запитів на кінцеві точки входу
5. **Валідація токенів**: Завжди валідуйте токени на стороні сервера

## Міграція з інших провайдерів

При міграції з аутентифікації тільки через Google:

<Code language="typescript" title="TypeScript">
{`// До (тільки Google)
<button onClick={() => signIn('google')}>
  Увійти через Google
</button>

// Після (множинні провайдери)
<div className="space-y-2">
  <button onClick={() => signIn('google')}>
    Увійти через Google
  </button>
  <button onClick={() => signIn('apple')}>
    Увійти через Apple
  </button>
</div>`}
</Code>

Ця реалізація надає безшовний, безпечний та зручний для користувача досвід входу через Apple для користувачів вашої платформи Ring.
